name: fleet-manager

services:
  timescale-fleet-manager:
    restart: unless-stopped
    container_name: timescale-fleet-manager
    image: timescale/timescaledb:latest-pg16
    volumes:
      - timescale-fleet-manager-v:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    environment:
      POSTGRES_PASSWORD: mysecretpassword
      TS_TUNE_MEMORY: 512MB
      TS_TUNE_NUM_CPUS: 2
    networks:
      - fleet-net
    tty: true
    stdin_open: true
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "5"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 30s
      timeout: 5s
      retries: 5

  fleet-management-fc0923d4b5bb24eba7fd84f5c5c93889-db-init:
    image: timescale/timescaledb:latest-pg16
    networks:
      - fleet-net
    depends_on:
      timescale-fleet-manager:
        condition: "service_healthy"
    command:
      - /bin/sh
      - -c
      - |
        DB_NAME="fc0923d4b5bb24eba7fd84f5c5c93889"
        DB_USER="fc0923d4b5bb24eba7fd84f5c5c93889"
        DB_PASS="fc0923d4b5bb24eba7fd84f5c5c93889"
        ADMIN_DSN="postgres://postgres:mysecretpassword@timescale-fleet-manager:5432/postgres"
        DB_DSN="postgres://$${DB_USER}:$${DB_PASS}@timescale-fleet-manager:5432/$${DB_NAME}"

        psql "$${ADMIN_DSN}" -v ON_ERROR_STOP=1 <<SQL
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = '$${DB_USER}') THEN
            EXECUTE format('CREATE ROLE %I LOGIN PASSWORD %L', '$${DB_USER}', '$${DB_PASS}');
          END IF;
        END
        \$\$;
        SELECT format('CREATE DATABASE %I', '$${DB_NAME}')
        WHERE NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = '$${DB_NAME}') \gexec
        GRANT ALL PRIVILEGES ON DATABASE "$${DB_NAME}" TO "$${DB_USER}";
        \connect "$${DB_NAME}";
        GRANT ALL ON SCHEMA _timescaledb_cache TO "$${DB_USER}";
        GRANT ALL ON SCHEMA _timescaledb_catalog TO "$${DB_USER}";
        GRANT ALL ON SCHEMA _timescaledb_config TO "$${DB_USER}";
        GRANT ALL ON SCHEMA _timescaledb_functions TO "$${DB_USER}";
        GRANT ALL ON SCHEMA _timescaledb_internal TO "$${DB_USER}";
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA _timescaledb_cache TO "$${DB_USER}";
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA _timescaledb_catalog TO "$${DB_USER}";
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA _timescaledb_config TO "$${DB_USER}";
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA _timescaledb_functions TO "$${DB_USER}";
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA _timescaledb_internal TO "$${DB_USER}";
        DO \$\$
        BEGIN
          IF EXISTS (
            SELECT 1
            FROM information_schema.schemata
            WHERE schema_name = '_timescaledb_debug'
          ) THEN
            EXECUTE format('GRANT ALL ON SCHEMA %I TO %I', '_timescaledb_debug', '$${DB_USER}');
            EXECUTE format(
              'GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA %I TO %I',
              '_timescaledb_debug',
              '$${DB_USER}'
            );
          END IF;
        END
        \$\$;
        SQL

        psql "$${DB_DSN}" -v ON_ERROR_STOP=1 <<SQL
        CREATE SCHEMA IF NOT EXISTS migration AUTHORIZATION "$${DB_USER}";
        SQL

  fleet-management-fc0923d4b5bb24eba7fd84f5c5c93889:
    container_name: fleet-management-fc0923d4b5bb24eba7fd84f5c5c93889
    user: "${UID:-1000}"
    build:
      context: .
      dockerfile: Dockerfile
    image: fleet-management:local
    depends_on:
      timescale-fleet-manager:
        condition: "service_healthy"
      fleet-management-fc0923d4b5bb24eba7fd84f5c5c93889-db-init:
        condition: "service_completed_successfully"
    environment:
      FLEET_MANAGER_PORT: 7011
      fleet-manager_internalStorage__connection__host: timescale-fleet-manager
      fleet-manager_internalStorage__connection__user: fc0923d4b5bb24eba7fd84f5c5c93889
      fleet-manager_internalStorage__connection__password: fc0923d4b5bb24eba7fd84f5c5c93889
      fleet-manager_internalStorage__connection__database: fc0923d4b5bb24eba7fd84f5c5c93889
      fleet-manager_root-user__username: admin
      fleet-manager_root-user__password: admin
      PLUGINS_FOLDER: /app/backend/plugins
    volumes:
      - "/run/dbus:/run/dbus:z"
      - "fm-fc0923d4b5bb24eba7fd84f5c5c93889-backend-cfg-v:/app/backend/cfg/"
      - "./plugins/fc0923d4b5bb24eba7fd84f5c5c93889/frontend/:/app/frontend/src/pages/plugin/:rw"
      - "./plugins/fc0923d4b5bb24eba7fd84f5c5c93889/backend/:/app/backend/plugins/:rw"
    restart: unless-stopped
    networks:
      - fleet-net
    ports:
      - "7011:7011"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  fleet-net:


volumes:
  timescale-fleet-manager-v:
  fm-fc0923d4b5bb24eba7fd84f5c5c93889-backend-cfg-v:
